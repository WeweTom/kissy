/*
Copyright 2013, KISSY v1.40dev
MIT Licensed
build time: Aug 29 11:54
*/
KISSY.add("scroll-view/drag",function(l,D,E){function v(b,c,a){var c=c.timeStamp,f=b.get("scroll"+l.ucfirst(a));b.startScroll[a]=f;b.swipe[a].startTime=c;b.swipe[a].scroll=f}function w(b,c,a,f){if(!x(b,a)){var d={pageX:c.touches[0].pageX,pageY:c.touches[0].pageY},e="left"==a?"pageX":"pageY",i=b.lastPageXY,j,g=b.startScroll[a]-(d[e]-f[e]),f=c.timeStamp,m=b.minScroll,k=b.maxScroll,h=b.lastDirection,p=b.swipe,n;i[e]&&(j=d[e]==i[e],n=0<d[e]-i[e]);b.get("bounce")||(g=Math.min(Math.max(g,m[a]),k[a]));g<
m[a]?(d=m[a]-g,d*=y,g=m[a]-d):g>k[a]&&(d=g-k[a],d*=y,g=k[a]+d);d=f-p[a].startTime;if(!j&&void 0!==h[a]&&h[a]!==n||d>F)p[a].startTime=f,p[a].scroll=g;b.set("scroll"+l.ucfirst(a),g);h[a]=n;i[e]=c[e]}}function x(b,c){return!b.allowScroll[c]&&b.get("left"==c?"lockX":"lockY")?1:0}function z(b,c,a,f){if(x(b,a))f();else{var d="scroll"+l.ucfirst(a),e=b.$contentEl,i=b.get(d),j={},g=b.minScroll,m=b.maxScroll,k=c.timeStamp,c=b.swipe,h;i<g[a]?h=g[a]:i>m[a]&&(h=m[a]);void 0!==h?(d={},d[a]=h,b.scrollTo(d,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:f})):b.pagesOffset?f():(h=k-c[a].startTime,c=i-c[a].scroll,0==h||0==c?f():(h=Math.min(Math.max(c/h,-A),A),j[a]={fx:{frame:G(b,h,i,d,m[a],g[a])}},e.animate(j,{duration:9999,queue:!1,complete:f})))}}function G(b,c,a,f,d,e){var i=c*t,j=1,g=0;return function(c){var k=l.now();if(j){var c=k-c.startTime,h=Math.exp(c*H),c=parseInt(a+i*(1-h)/-B);c>e&&c<d?(this.lastValue===c&&(this.finished=1),this.lastValue=c,b.set(f,c)):(j=0,i*=h,a=c<=e?e:d,g=k)}else c=k-g,k=
c/t,k*=Math.exp(-I*k),c=parseInt(i*k),0===c&&(this.finished=1),b.set(f,a+c)}}function J(b){if(!this.get("disabled")){var c={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY},a=this.isScrolling;this.stopAnimation();a&&(a=this.get("pageIndex"),this.fire("scrollEnd",l.mix({fromPageIndex:a,pageIndex:a},c)));C(this);this.startMousePos=c;v(this,b,"left");v(this,b,"top");this.fire("scrollStart",c);this.isScrolling=1}}function K(b){var c=this.startMousePos;if(c&&this.isScrolling){var a=this.get("lockX"),
f=this.get("lockY"),d={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};if(a||f){var e;if(!(e=this.dragInitDirection))this.dragInitDirection=e=Math.abs(d.pageX-c.pageX)>Math.abs(d.pageY-c.pageY)?"left":"top";if(a&&"left"==e&&!this.allowScroll[e]){this.isScrolling=0;return}if(f&&"top"==e&&!this.allowScroll[e]){this.isScrolling=0;return}}b.preventDefault();w(this,b,"left",c);w(this,b,"top",c);this.fire("scrollMove",d)}}function L(b){function c(){f++;if(2==f){var c=function(){a.isScrolling=0;a.fire("scrollEnd",
{pageX:b.pageX,pageY:b.pageY,fromPageIndex:p,pageIndex:a.get("pageIndex")})};if(a.pagesOffset){a.get("snapThreshold");var d=a.get("snapDuration"),h=a.get("snapEasing"),p=a.get("pageIndex"),n=a.get("scrollLeft"),o=a.get("scrollTop"),d={duration:d,easing:h,complete:c},h=a.pagesOffset.concat([]);a.isScrolling=0;if(j||g)if(j&&g){var q=[],r=void 0;l.each(h,function(a){a&&(0<e&&a.left>n?q.push(a):0>e&&a.left<n&&q.push(a))});var s;0<i?(s=Number.MAX_VALUE,l.each(q,function(a){a.top>o&&s<a.top-o&&(s=a.top-
o,r=q.index)})):(s=Number.MAX_VALUE,l.each(q,function(a){a.top<o&&s<o-a.top&&(s=o-a.top,r=q.index)}));void 0!=r?r!=p?a.scrollToPage(r,d):(a.scrollToPage(r),c()):c()}else j||g?(c=a._getPageIndexFromXY(j?n:o,j,j?e:i),a.scrollToPage(c,d)):(a.scrollToPage(a.get("pageIndex")),c())}else c()}}var a=this,f=0,d=a.startMousePos;if(d&&a.isScrolling){var e=d.pageX-b.pageX,i=d.pageY-b.pageY,d=a.get("snapThreshold"),j=a.allowScroll.left&&Math.abs(e)>d,g=a.allowScroll.top&&Math.abs(i)>d;a.fire("dragend",{pageX:b.pageX,
pageY:b.pageY});z(a,b,"left",c);z(a,b,"top",c)}}function C(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={};b.dragInitDirection=null}function M(b){b.preventDefault()}var y=0.5,u=E.Gesture,F=300,A=6,t=20,B=Math.log(0.95),H=B/t,I=0.3;return D.extend({bindUI:function(){this.$contentEl.on("dragstart",M).on(u.start,J,this).on(u.move,K,this).on(u.end,L,this)},syncUI:function(){C(this)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();
self.isScrolling=0}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","node"]});
